<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="referrer" content="no-referrer">
  <title>抖音广告数据监控平台</title>
  <script src="./js/axios.js"></script>
  <link rel="icon" type="image/png" href="./js/抖音.png">
  <link rel="stylesheet" href="./js/element.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }

    .el-radio-button:first-child .el-radio-button__inner {
      border-left: 0;
      border-radius: 12px 0 0 12px;
    }

    .el-radio-button:last-child .el-radio-button__inner {
      border-radius: 0 12px 12px 0;
    }
    .el-table--striped .el-table__body tr.el-table__row--striped td.el-table__cell {
      background-color: #1e293b;
    }
    
    .el-table tr td {
      background-color: #1e293b!important;
    }
    .el-table tr {
      background-color: #1e293b!important;
    }

    .el-table--border::after, .el-table--group::after, .el-table::before {
      background-color: #334155;
    }


    .el-table tr:hover {
      /* background: none!important; */
      background-color: rgba(56, 189, 248, 0.15)!important;
    }
    .el-table tr:hover td {
      /* background-color: rgba(56, 189, 248, 0.15) !important; */
      background: none !important;
    }
    .el-table--scrollable-y .el-table__body-wrapper {
      padding-bottom: 100px;
    }
    .el-table td.el-table__cell div {
      justify-content: center;
    }
    .el-table td.el-table__cell, .el-table th.el-table__cell.is-leaf {
      background-color: #1e293b;
      border: none;
      border-bottom: 1px solid #334155;
    }
    .el-table td.el-table__cell, .el-table th.el-table__cell.is-leaf {
      border: none;
      border-bottom: 1px solid #334155;
    }




    .el-table__footer-wrapper {
      
      position: absolute;
      bottom: 0;
    }
    .el-table__footer-wrapper tbody td.el-table__cell, .el-table__header-wrapper tbody td.el-table__cell {
      background-color: #1e293b;
      color: #e2e8f0;
    }



    html,
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
    }

    #app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }

    .header-section {
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid #334155;
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    .header-title {
      font-size: 24px;
      font-weight: 700;
      color: #f1f5f9;
      display: flex;
      align-items: center;
      gap: 12px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .header-title img {
      width: 32px;
      height: 32px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .controls-container {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .content-section {
      flex: 1;
      overflow: hidden;
      padding: 24px;
    }

    .tab-content {
      height: 100%;
      display: flex;
      flex-direction: column;
      background: #1e293b;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid #334155;
    }

    /* 深色表格样式 */
    .el-table {
      flex: 1;
      background: #1e293b;
      color: #e2e8f0;
      border-radius: 0;
    }

    .el-table__header {
      background: #334155;
    }

    .el-table th {
      background: #334155 !important;
      color: #cbd5e1;
      font-weight: 600;
      font-size: 14px;
      padding: 16px 8px;
      border-bottom: 1px solid #475569;
    }

    .el-table td {
      background: #1e293b;
      color: #e2e8f0;
      border-bottom: 1px solid #334155;
      padding: 12px 8px;
      font-size: 13px;
    }

    .el-table--striped .el-table__body tr.el-table__row--striped td {
      background: #262626;
    }

    .el-table__expanded-cell {
      background: #262626 !important;
      border-bottom: 1px solid #334155;
    }

    /* 深色表单元素 */
    .el-input__inner,
    .el-select .el-input__inner {
      background: #334155;
      border: 1px solid #475569;
      color: #e2e8f0;
      border-radius: 8px;
    }

    .el-input__inner:focus,
    .el-select .el-input__inner:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .el-select-dropdown {
      background: #334155;
      border: 1px solid #475569;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .el-select-dropdown__item {
      color: #e2e8f0;
    }

    .el-select-dropdown__item:hover {
      background: #475569;
    }

    /* 深色按钮 */
    .el-button--primary {
      background: #3b82f6;
      border-color: #3b82f6;
    }

    .el-button--primary:hover {
      background: #2563eb;
      border-color: #2563eb;
    }

    .el-button--success {
      background: #10b981;
      border-color: #10b981;
    }

    .el-button--success:hover {
      background: #059669;
      border-color: #059669;
    }

    /* 深色开关 */
    .el-switch__core {
      background: #475569;
    }

    .el-switch.is-checked .el-switch__core {
      background: #3b82f6;
    }

    /* 深色分页 */
    .el-pagination.is-background .el-pager li {
      background: #334155;
      border: 1px solid #475569;
      color: #e2e8f0;
    }

    .el-pagination.is-background .el-pager li.active {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }

    /* 深色标签 */
    .el-tag--primary {
      background: #1e40af;
      border-color: #1e40af;
      color: white;
    }

    .el-tag--warning {
      background: #d97706;
      border-color: #d97706;
      color: white;
    }

    /* 深色网格布局 */
    .phone-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      padding: 32px;
      height: calc(100vh - 180px);
      overflow-y: auto;
    }

    .phone-card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 16px;
      width: 30vw;
      min-width: 554px;
      min-height:608px;
      flex-shrink: 0;
      /* overflow: hidden; */
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    @media screen and (max-width: 1920px) {
      .phone-card {
        width: 45.5vw;
      }
    }

    @media screen and (max-width: 1500px) {
      .phone-card {
        width: 80vw;
      }
    }

    .phone-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
      border-color: #475569;
    }

    .phone-header {
      /* background: linear-gradient(135deg, #0c1445 0%, #020617 100%); */
      background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%);
      /* background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); */
      color: white;
      padding: 24px;
      display: flex;
      border-radius: 16px 16px 0 0;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .phone-content {
      padding: 24px;
    }

    /* 深色图片网格 */
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      /* gap: 24px; */
      padding: 32px;
      height: calc(100vh - 180px);
      overflow-y: auto;
    }

    .image-card {
      width: 335px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 16px;
      /* overflow: hidden; */
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
    }

    .image-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
      border-color: #475569;
    }

    .image-header {
      /* background: #334155; */
      background: linear-gradient(135deg, #0c1445 0%, #020617 100%);
      padding: 20px;
      border-radius: 16px 16px 0 0;
      font-weight: 600;
      color: #e2e8f0;

      border-bottom: 1px solid #475569;
    }

    .image-content {
      padding: 24px;
      text-align: center;
    }

    .image-content img {
      width: 250px;
      object-fit: contain;
      border-radius: 12px;
      transition: transform 0.3s ease;
    }

    .image-content img:hover {
      transform: scale(1.02);
    }

    /* 深色视窗 */
    .viewport {
      background: #0f172a;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 12px;
      font-family: 'Fira Code', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      height: 450px;
      overflow-y: auto;
      border: 1px solid #334155;
    }

    .viewport .itemValue {
      padding: 8px 0;
      border-bottom: 1px solid #334155;
      transition: all 0.2s ease;
    }

    .viewport .itemValue:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    /* 深色状态标签 */
    .status-badge {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-online {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .status-offline {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    /* 深色单选按钮组 */
    .el-radio-group {
      background: #334155;
      border-radius: 12px;
      height: 42px;
      line-height: 42px;
      /* padding: 4px; */
    }

    .el-radio-button--medium .el-radio-button__inner {
      height: 42px;
      line-height: 42px;
      padding: 0 16px;
    }


    .el-radio-button__inner {
      background: transparent;
      border: none;
      color: #94a3b8;
      font-weight: 500;
      border-radius: 8px;
      transition: all 0.2s ease;
      height: 42px;
      line-height: 42px;
      padding: 0 16px;
    }

    .el-radio-button__orig-radio:checked+.el-radio-button__inner {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      height: 42px;
      line-height: 42px;
      padding: 0 16px;

    }

    /* 深色对话框 */
    .el-dialog {
      background: #1e293b;
      border: 1px solid #334155;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    .el-dialog__title {
      color: #f1f5f9;
    }

    .el-dialog__body {
      color: #e2e8f0;
    }

    /* 加载动画 */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(10px);
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #334155;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* 滚动条样式 */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1e293b;
    }

    ::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }

    /* 扩展内容卡片 */
    .expanded-content {
      background: #262626;
      border-radius: 12px;
      margin: 20px;
      padding: 24px;
      border: 1px solid #334155;
    }

    .ad-card {
      background: #334155;
      border: 1px solid #475569;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      text-align: center;
    }

    .ad-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      border-color: #64748b;
    }

    .ad-image {
      width: 250px;
      /* height: 250px; */
      object-fit: contain;
      border-radius: 12px;
      transition: transform 0.3s ease;
    }

    .ad-image:hover {
      transform: scale(1.02);
    }

    /* 霓虹文字效果 */
    .neon-text {
      text-shadow: 0 0 10px #3b82f6, 0 0 20px #3b82f6, 0 0 30px #3b82f6;
    }
  </style>
  <script src="./js/vue.js"></script>
  <script src="./js/element.js"></script>
  <script type="text/javascript" src="./websocket.js"></script>
</head>

<body>
  <div id="app">
    <div class="header-section">
      <!-- <h1 class="header-title neon-text">
        <img src="./js/抖音.png" alt="Logo">
        抖音广告数据监控平台
      </h1> -->
      <el-radio-group v-model="activeName" size="medium">
        <el-radio-button label="first">
          <i class="fas fa-chart-line"></i> 数据总览
        </el-radio-button>
        <el-radio-button label="three">
          <i class="fas fa-desktop"></i> 实时监控
        </el-radio-button>
        <el-radio-button label="second">
          <i class="fas fa-images"></i> 图片管理
        </el-radio-button>

      </el-radio-group>

      <div class="controls-container">


        <div class="control-group" v-show="activeName == 'first'">
          <el-tooltip content="切换数据范围" placement="top">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 13px; color: #94a3b8;">{{today == '0'?'全部数据':'今日数据'}}</span>
              <el-switch v-model="today" active-color="#3b82f6" inactive-color="#10b981" active-value="100"
                @change="changeDay" inactive-value="0">
              </el-switch>
            </div>
          </el-tooltip>

          <el-select filterable @change="changeTime" clearable size="medium" v-model="timeListValue" placeholder="选择日期"
            style="width: 150px;">
            <el-option v-for="item in timeList" :key="item.value" :label="item.text" :value="item.value">
            </el-option>
          </el-select>

          <el-button type="success" size="medium" @click="expandStatusFun" icon="el-icon-folder-opened" plain>
            {{expandStatus ? '折叠全部' : '展开全部'}}
          </el-button>

          <el-button type="primary" size="medium" @click="loadImg" icon="el-icon-refresh-right" plain>
            刷新数据
          </el-button>
        </div>

        <div class="control-group" v-show="activeName == 'three'">
          <el-button type="success" size="medium" @click="clearData" icon="el-icon-refresh-right" plain>
            清屏
          </el-button>

          <el-tooltip content="设备在线状态" placement="top">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 13px; color: #94a3b8;">{{isOnline == '0'?'全部设备':'在线设备'}}</span>
              <el-switch v-model="isOnline" active-color="#3b82f6" inactive-color="#10b981" active-value="100"
                @change="changeOnline" inactive-value="0">
              </el-switch>
            </div>
          </el-tooltip>

          <el-select filterable @change="changeItemPhone" multiple clearable size="medium" v-model="socketValuePhone"
            placeholder="选择设备" style="width: 300px;">
            <el-option v-for="item in modelList" :key="item.value" :label="item.text" :value="item.value">
            </el-option>
          </el-select>
        </div>
      </div>
    </div>

    <div class="content-section">
      <div class="tab-content" v-show="activeName == 'first'" label="查看数据" name="first">
        <el-table v-loading="loadingData" ref="el_Table" :data="tableData"  show-summary
          :summary-method="getSummaries" height="30vh" @expand-change="changeRow" style="width: 100%;">

          <el-table-column type="expand">
            <template slot-scope="props">
              <div class="expanded-content">
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px;">
                  <div v-for="(item,index) in props.row.currentSuccessData" :key="index" class="ad-card">
                    <div
                      style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                      <span style="font-weight: 600; color: #e2e8f0; font-size: 14px;">
                        {{ timestampToTime(item.lastLookTime) || '--' }}
                      </span>
                      <div>
                        <el-tag v-if="item.downLoad" type="success" size="small" effect="dark">
                          <i class="fas fa-check"></i> 已下载
                        </el-tag>
                        <el-tag v-if="item.isClick" type="primary" size="small" effect="dark" style="margin-left: 8px;">
                          <i class="fas fa-mouse-pointer"></i> 已点击
                        </el-tag>
                      </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 16px; color: #94a3b8;">
                      <span>当日观看: <strong style="color: #10b981;">{{ item.todayLookNum }}</strong></span>
                      <!-- <span>状态: <el-tag size="mini" :type="item.img ? 'success' : 'info'">{{ item.img ? '有图片' : '无图片'
                          }}</el-tag></span> -->
                    </div>
                    <img class="ad-image" :src="item.img" alt="广告图片"
                      @error="item.img = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'320\' height=\'220\'%3E%3Crect width=\'320\' height=\'220\' fill=\'%23334155\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%2394a3b8\' font-family=\'Inter\'%3E暂无图片%3C/text%3E%3C/svg%3E'">
                  </div>
                </div>
                <div style="display: flex; justify-content: center; margin-top: 32px;">
                  <el-pagination background @current-change="handlePageRow($event, props.row)"
                    :current-page.sync="props.row.current" :page-size="props.row.pageSize"
                    layout="prev, pager, next, jumper, total" :total="props.row.successAdList.length">
                  </el-pagination>
                </div>
              </div>
            </template>
          </el-table-column>

          <el-table-column prop="appName" align="center" label="小程序名称" width="150" :filters="appNameList"
            :filter-method="filterModelName">
            <template scope="scope">
              <el-tag type="primary" effect="dark">{{ scope.row.appName }}</el-tag>
            </template>
          </el-table-column>

          <!-- <el-table-column prop="model" align="center" width="150" label="设备型号">
            <template scope="scope">
              <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="fas fa-mobile-alt" style="color: #3b82f6;"></i>
                <span style="font-weight: 500;">{{ phoneIdToNameList[scope.row.phoneId] ?
                  phoneIdToNameList[scope.row.phoneId] : scope.row.model }}</span>
              </div>
            </template>
          </el-table-column> -->

          <el-table-column prop="phoneId" width="150" align="center" label="设备名称" :filters="modelList" :filter-method="filterModel">

            <template scope="scope">
              <code
                style="background: #334155; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                <!-- {{ scope.row.phoneId }} -->
                {{ phoneIdToNameList[scope.row.phoneId] ?
                  phoneIdToNameList[scope.row.phoneId] : scope.row.model }}
              </code>
            </template>
          </el-table-column>

          <el-table-column prop="lastLookTime" align="center" label="最近观看时间" sortable width="200" sortable
            column-key="lastLookTime" :filters="timeList" :filter-method="filterHandler">
            <template scope="scope">
              <div style="display: flex; align-items: center; gap: 8px; color: #e2e8f0;">
                <i class="far fa-clock" style="color: #3b82f6;"></i>
                <span>{{ timestampToTime(scope.row.lastLookTime) }}</span>
              </div>
            </template>
          </el-table-column>

          <el-table-column align="center" prop="ip" width="150" label="IP地址">
            <template scope="scope">
              <div style="display: flex; align-items: center; gap: 8px; color: #e2e8f0;">
                <i class="fas fa-map-marker-alt" style="color: #3b82f6;"></i>
                <span>{{ scope.row.ip ? scope.row.ip.split("--")[0] : "" }}</span>
              </div>
            </template>
          </el-table-column>

          <!-- <el-table-column align="center" prop="ip" label="地理位置" width="150">
            <template scope="scope">
              <div style="display: flex; align-items: center; gap: 8px; color: #e2e8f0;">
                <i class="fas fa-globe-asia" style="color: #3b82f6;"></i>
                <span>{{ scope.row.ip ? scope.row.ip.split("--")[1] : '' }}</span>
              </div>
            </template>
          </el-table-column> -->

          <el-table-column align="center" prop="ip" label="应用" width="100">
            <template scope="scope">
              <div style="display: flex; align-items: center; gap: 8px; color: #e2e8f0;">
                <!-- <i class="fas fa-app-store" style="color: #3b82f6;"></i> -->
                <span>{{ scope.row.customObj ? scope.row.customObj.appPhoneName :'' }}</span>
              </div>
            </template>
          </el-table-column>

          <el-table-column align="center" prop="customObj" label="广告类型" width="120"
            :filters="[{text:'激励视频',value:'rewardVideo'},{text:'插屏广告',value:'chaPing'}]"
            :filter-method="filterModelAdType">
            <template scope="scope">
              <el-tag :type="scope.row.customObj && scope.row.customObj.adType === 'chaPing' ? 'info' : 'primary'"
                size="medium" effect="dark">
                <i :class="scope.row.customObj && scope.row.customObj.adType === 'chaPing' ? 'fas fa-window-maximize' : 'fas fa-play-circle'"
                  style="margin-right: 4px;"></i>
                {{ scope.row.customObj ? scope.row.customObj.adType == 'chaPing' ? '插屏广告' : '激励视频' : '' }}
              </el-tag>
            </template>
          </el-table-column>

          <el-table-column prop="todayLookNum" align="center" sortable label="今日观看">
            <template scope="scope">
              <div style="color: #10b981; font-weight: 700; font-size: 16px;">
                <i class="fas fa-eye" style="margin-right: 4px;"></i>
                {{ scope.row.todayLookNum }}
              </div>
            </template>
          </el-table-column>

          <el-table-column prop="todayClickNum" align="center" sortable label="今日点击">
            <template scope="scope">
              <div style="color: #3b82f6; font-weight: 700; font-size: 16px;">
                <i class="fas fa-mouse-pointer" style="margin-right: 4px;"></i>
                {{ scope.row.todayClickNum }}
              </div>
            </template>
          </el-table-column>

          <el-table-column prop="clickNumTotal" align="center" sortable label="总点击">
            <template scope="scope">
              <div style="color: #8b5cf6; font-weight: 700; font-size: 16px;">
                <i class="fas fa-bullseye" style="margin-right: 4px;"></i>
                {{ scope.row.clickNumTotal }}
              </div>
            </template>
          </el-table-column>

          <el-table-column prop="todayDownLoad" align="center" sortable label="今日下载">
            <template scope="scope">
              <div style="color: #f59e0b; font-weight: 700; font-size: 16px;">
                <i class="fas fa-download" style="margin-right: 4px;"></i>
                {{ scope.row.todayDownLoad }}
              </div>
            </template>
          </el-table-column>

          <el-table-column prop="downLoadTotal" align="center" sortable label="总下载">
            <template scope="scope">
              <div style="color: #ef4444; font-weight: 700; font-size: 16px;">
                <i class="fas fa-download" style="margin-right: 4px;"></i>
                {{ scope.row.downLoadTotal }}
              </div>
            </template>
          </el-table-column>

          <el-table-column prop="lookAdTotal" align="center" sortable label="总数量">
            <template scope="scope">
              <div style="color: #64748b; font-weight: 700; font-size: 16px;">
                <i class="fas fa-chart-bar" style="margin-right: 4px;"></i>
                {{ scope.row.lookAdTotal }}
              </div>
            </template>
          </el-table-column>
        </el-table>
      </div>

      <div class="tab-content" v-show="activeName == 'three'" label="实时监控" name="three">
        <div class="phone-grid">
          <div class="phone-card" v-if="item.display" v-for="(item,index) in socketModelList" :key="index">
            <div class="phone-header">
              <div style="display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-mobile-alt" style="font-size: 24px;"></i>
                <div>
                  <div style="font-size: 18px; font-weight: 700; margin-bottom: 2px;">
                    {{phoneIdToNameList[item.phoneId] ? phoneIdToNameList[item.phoneId] : item.text}}
                  </div>
                  <div style="font-size: 12px; opacity: 0.8;">设备ID: {{item.phoneId}}</div>
                </div>
              </div>
              <!-- <span :class="['status-badge', item.isOnline ? 'status-online' : 'status-offline']">
                <i :class="item.isOnline ? 'fas fa-circle' : 'fas fa-circle'" style="margin-right: 4px;"></i>
                {{ item.isOnline ? '在线' : '离线' }}
              </span> -->
              <el-switch v-model="item.show" @change="sendMsgToPhone(item)" active-color="#3b82f6"
                inactive-color="#10b981" active-text="查看图片" inactive-text="查看数据">
              </el-switch>
            </div>
            <div class="phone-content">
              <!-- <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <span style="font-size: 12px; color: #94a3b8;">
                  <i class="fas fa-clock" style="margin-right: 4px;"></i>
                  {{timeStr}}
                </span>
                <el-switch 
                  v-model="item.show" 
                  @change="sendMsgToPhone(item)" 
                  active-color="#3b82f6"
                  inactive-color="#10b981"
                  active-text="查看图片"
                  inactive-text="查看数据">
                </el-switch>
              </div> -->

              <div v-if="!item.show" style="height: 450px;">
                <div class="viewport" :id="['scrollView'+index]">
                  <div class="itemValue" v-for="(value,index) in item.messageList" :key="index">
                    <i class="fas fa-circle" style="font-size: 6px; margin-right: 8px; color: #3b82f6;"></i>
                    {{value}}
                  </div>
                </div>
              </div>

              <div v-else style="position: relative;text-align: center;">
                <div style="display: flex;justify-content: space-between;height:450px;">
                  <img :src="item.img" @click="clickImg($event,item)"
                    style="width: 253px; object-fit: contain; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);"
                    v-loading="item.loading"
                    @error="item.img = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100%25\' height=\'450\'%3E%3Crect width=\'100%25\' height=\'450\' fill=\'%23334155\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%2394a3b8\' font-family=\'Inter\' font-size=\'16\'%3E暂无截图%3C/text%3E%3C/svg%3E'">

                  <div style="width: calc(100% - 275px);height:100%;">

                    <div class="viewport" style="width:100%;height:100%;flex-shrink: 0;" :id="['scrollView'+index]">
                      <div class="itemValue" v-for="(value,index) in item.messageList" :key="index">
                        <i class="fas fa-circle" style="font-size: 6px; margin-right: 8px; color: #3b82f6;"></i>
                        {{value}}
                      </div>
                    </div>
                  </div>
                </div>


                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 20px;">
                  <el-dropdown @command="handleCommand" style="width: 100%;">
                    <el-button type="success" size="medium"
                      style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none;">
                      <i class="fas fa-camera" style="margin-right: 8px;"></i>
                      更新图片
                      <i class="el-icon-arrow-down el-icon--right"></i>
                    </el-button>
                    <el-dropdown-menu slot="dropdown">
                      <el-dropdown-item :command="beforeHandleCommand(item,'截图')">
                        <i class="fas fa-camera" style="margin-right: 8px;"></i> 立即截图
                      </el-dropdown-item>
                      <el-dropdown-item :command="beforeHandleCommand(item,'自动截图')">
                        <i class="fas fa-sync" style="margin-right: 8px;"></i> 自动更新
                      </el-dropdown-item>
                      <el-dropdown-item :command="beforeHandleCommand(item,'清除')">
                        <i class="fas fa-trash" style="margin-right: 8px;"></i> 清除数据
                      </el-dropdown-item>
                    </el-dropdown-menu>
                  </el-dropdown>

                  <el-dropdown @command="handleCommand" style="width: 100%;">
                    <el-button type="primary" size="medium"
                      style="width: 100%; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); border: none;">
                      <i class="fas fa-cogs" style="margin-right: 8px;"></i>
                      下发指令
                      <i class="el-icon-arrow-down el-icon--right"></i>
                    </el-button>
                    <el-dropdown-menu slot="dropdown">
                      <el-dropdown-item :command="beforeHandleCommand(item,'重启')">
                        <i class="fas fa-redo" style="margin-right: 8px;"></i> 重启任务
                      </el-dropdown-item>
                      <el-dropdown-item :command="beforeHandleCommand(item,'养机')">
                        <i class="fas fa-leaf" style="margin-right: 8px;"></i> 抖音养机
                      </el-dropdown-item>
                      <el-dropdown-item :command="beforeHandleCommand(item,'快速任务')">
                        <i class="fas fa-rocket" style="margin-right: 8px;"></i> 快速任务
                      </el-dropdown-item>
                      <el-dropdown-item :command="beforeHandleCommand(item,'停止任务')">
                        <i class="fas fa-stop" style="margin-right: 8px;"></i> 停止任务
                      </el-dropdown-item>
                      <el-dropdown-item divided :command="beforeHandleCommand(item,'屏幕上滑')">
                        <i class="fas fa-arrow-up" style="margin-right: 8px;"></i> 向上滑动
                      </el-dropdown-item>
                      <el-dropdown-item :command="beforeHandleCommand(item,'屏幕下滑')">
                        <i class="fas fa-arrow-down" style="margin-right: 8px;"></i> 向下滑动
                      </el-dropdown-item>
                      <el-dropdown-item :command="beforeHandleCommand(item,'屏幕左滑')">
                        <i class="fas fa-arrow-left" style="margin-right: 8px;"></i> 向左滑动
                      </el-dropdown-item>
                      <el-dropdown-item :command="beforeHandleCommand(item,'屏幕右滑')">
                        <i class="fas fa-arrow-right" style="margin-right: 8px;"></i> 向右滑动
                      </el-dropdown-item>
                      <el-dropdown-item :command="beforeHandleCommand(item,'多任务')">
                        <i class="fas fa-th-large" style="margin-right: 8px;"></i> 多任务界面
                      </el-dropdown-item>
                      <el-dropdown-item :command="beforeHandleCommand(item,'返回主页')">
                        <i class="fas fa-home" style="margin-right: 8px;"></i> 返回主页
                      </el-dropdown-item>
                      <el-dropdown-item :command="beforeHandleCommand(item,'返回')">
                        <i class="fas fa-undo" style="margin-right: 8px;"></i> 返回上一步
                      </el-dropdown-item>
                    </el-dropdown-menu>
                  </el-dropdown>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" v-show="activeName == 'second'" label="图片管理" name="second">
        <div class="image-grid">
          <div v-for="(item,index) in imgList" :key="index" class="image-card">
            <div class="image-header">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <i class="fas fa-mobile-alt" style="color: #3b82f6; font-size: 20px;"></i>
                  <div>
                    <div style="font-weight: 700; margin-bottom: 2px; color: #e2e8f0;">
                      {{phoneIdToNameList[item.model.split('-')[item.model.split('-').length-1]] ?
                      phoneIdToNameList[item.model.split('-')[item.model.split('-').length-1]] : item.model}}
                    </div>
                    <!-- 94a3b8 -->
                    <div style="font-size: 14px; color: #fff;">
                      {{item.time}}

                    </div>
                  </div>
                </div>
                <el-tag type="success" effect="dark" size="medium">
                  <i class="fas fa-tag" style="margin-right: 4px;"></i>
                  {{item.appName}}
                </el-tag>
              </div>
            </div>
            <div class="image-content">
              <img :src="item.download_url" alt="广告图片"
                @error="item.download_url = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'350\' height=\'300\'%3E%3Crect width=\'350\' height=\'300\' fill=\'%23334155\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%2394a3b8\' font-family=\'Inter\' font-size=\'16\'%3E图片加载中...%3C/text%3E%3C/svg%3E'"
                style="cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
              <!-- <div style="margin-top: 16px; text-align: center; font-size: 14px; color: #94a3b8;">
                <i class="far fa-clock" style="margin-right: 8px;"></i>
                设备ID: {{item.model.split('-')[item.model.split('-').length-1]}}
              </div> -->
            </div>
          </div>
        </div>

        <div style="display: flex; justify-content: center; padding: 32px;">
          <el-pagination background @current-change="handlePage" :current-page.sync="current" :page-size="pageSize"
            layout="prev, pager, next, jumper, total, sizes" :total="pageTotal" :page-sizes="[15, 30, 60, 100]"
            style="--el-pagination-background-color: #334155; --el-pagination-button-color: #e2e8f0;">
          </el-pagination>
        </div>
      </div>
    </div>

    <el-dialog title="请输入访问Token" :visible.sync="dialogVisible" width="400px" @close="dialogVisible = false"
      :close-on-click-modal="false" :show-close="false" custom-class="dark-dialog">
      <div style="padding: 20px 0;">
        <el-input v-model="tokenData" placeholder="请输入访问Token" size="large" prefix-icon="fas fa-key"
          @keyup.enter.native="confirm" style="--el-input-background-color: #334155; --el-input-border-color: #475569;">
        </el-input>
      </div>
      <span slot="footer" class="dialog-footer">
        <el-button @click="dialogVisible = false" size="medium" plain>取 消</el-button>
        <el-button type="primary" @click="confirm" :loading="loadingData" size="medium"
          style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); border: none;">
          <i class="fas fa-unlock" style="margin-right: 8px;"></i>
          确 定
        </el-button>
      </span>
    </el-dialog>

    <div v-if="loadingData && !dialogVisible" class="loading-overlay">
      <div style="text-align: center;">
        <div class="loading-spinner"></div>
        <div style="margin-top: 16px; color: #e2e8f0; font-size: 14px;">加载中...</div>
      </div>
    </div>
  </div>

  <script>
    new Vue({
      el: '#app',
      data: function () {
        return {
          isOnline: false,
          loadingData: false,
          tokenData: '',
          dialogVisible: false,
          tableData: [],
          deviceId: '',
          timeList: [],
          modelList: [],
          activeName: 'first',
          imgList: [],
          today: '100',
          tableDataClone: [],
          timeListValue: '',
          appNameList: [],
          expandStatus: false,
          socketModelList: [],
          socket: null,
          timeStr: '',
          isListening: false,
          socketTimeOut: 10, // socket10分钟 检测报警
          socketTime: null,
          isConect: false,
          socketValuePhone: [],
          copySocketModelList: [],
          phoneIdToNameList: {
            "071882201": 'vivoX23-坏屏幕',
            "531011851": '荣耀30',
            "131391382": '荣耀20',
            "371752232": 'vivoX23-好屏幕',
            "692411262": 'Mate20',
            "351912422": "Mate20Pro",
            "491061091": '新买的mate20Pro',
            "042301751": 'nove5Pro',
            "811147186": '荣耀V20',

          },
          staySocketNum: 1500,
          pageSize: 15,// 预览的图片数
          pageTotal: 0,
          current: 1,
          imgDataTotal: []
        }
      },
      mounted() {
        setInterval(this.displayTime, 1000);
        let today = new Date().getTime()
        let that = this

        function getDay(time) {
          return that.timestampToTime(time, true)
        }
        for (var i = 0; i < 365; i++) {
          this.timeList.push({
            text: getDay(today - (i) * (24 * 60 * 60 * 1000), true),
            value: getDay(today - (i) * (24 * 60 * 60 * 1000), true)
          })
        }

        // 查看备份数据 this.checkCopyData()

        this.loadImg()

      },
      methods: {
        getPinYin(name) {
          if (name.indexOf('luoxue') > -1) {
            return '洛雪'
          } else if (name.indexOf('yunfan') > -1) {
            return '云帆'
          } else if (name.indexOf('haitun') > -1) {
            return '海豚'
          } else if (name.indexOf('ningmeng') > -1) {
            return '柠檬'
          } else if (name.indexOf('chengzi') > -1) {
            return '橙子'
          } else if (name.indexOf('fanqie') > -1) {
            return '番茄'
          } else if (name.indexOf('juzi') > -1) {
            return '橘子'
          } else if (name.indexOf('xiongmao') > -1) {
            return '熊猫'
          } else if (name.indexOf('xigua') > -1) {
            return '西瓜'
          } else if (name.indexOf('youchuang') > -1) {
            return '优创汇'
          } else if (name.indexOf('shuzi') > -1) {
            return '数字大挑战'
          } else {
            return '洛雪'
          }
        },
        checkCopyData() {
          this.handleTableData(adData)
        },
        changeOnline() {
          // console.log(this.socketModelList,this.isOnline)
          this.socketModelList = this.socketModelList.map(value => {
            value.display = false
            if (value.isOnline) {
              value.display = true
            }
            return value
          })

          if (this.isOnline == 0) {
            this.socketModelList = this.socketModelList.map(value => {
              value.display = true
              return value
            })
          }

        },
        changeItemPhone() {
          this.socketModelList = this.socketModelList.map(value => {
            value.display = false
            this.socketValuePhone.map(item => {
              if (value.phoneId == item) {
                value.display = true
              }
            })
            return value
          })

          if (this.socketValuePhone.length == 0) {
            this.socketModelList = this.socketModelList.map(value => {
              value.display = true
              return value
            })
          }


        },
        expandStatusFun() {
          var that = this;
          that.expandStatus = !that.expandStatus;
          //一级的展开和折叠
          that.tableData.forEach(function (item) {
            that.expandDataFun(item, that.expandStatus); //展开/折叠全部-数据处理
          });
        },
        //展开/折叠全部-逐行数据处理
        expandDataFun(row_item, status) {
          var that = this;
          that.$refs.el_Table.toggleRowExpansion(row_item, status);
          if (row_item.children != undefined && row_item.children != null) {
            //使用递归遍历每一级
            row_item.children.forEach(function (item) {
              that.expandDataFun(item, status); //展开/折叠全部-数据处理
            });
          }

        },
        changeTime(val) {
          // console.log(this.tableDataClone,'this.tableDataClone')
          let arr = []
          this.tableDataClone.map(value => {
            value.successAdList.map(item => {
              // console.log(item)
              item.time = this.timestampToTime(item.lastLookTime)
              arr.push(item)
            })

          })
          // console.log(arr,'dddddd')
          let newArr = []
          arr.map(value => {
            // console.log(value.time,'value.time')
            if (value.time.indexOf(val) > -1) {
              newArr.push(value)
            }
          })
          let obj = {}
          let newArr1 = []

          newArr.map((value, index) => {
            value.successAdList = []
            value.newId = value.appName + value.phoneId
          })
          // console.log(newArr,'newArr1')

          newArr.map((value, index) => {

            if (!obj[value.newId]) {
              newArr1.push(value)
              obj[value.newId] = value.newId
            } else {
              newArr1.map(item => {
                if (item.newId == value.newId) {
                  item.successAdList.push(value)
                }
              })
            }
          })

          newArr1.map(value => {
            value.successAdList.unshift(value)
          })

          newArr1.map(value => {
            value.todayLookNum = value.successAdList.length
            value.successAdList.map(item => {
              // item.lastLookTime = item.time
              this.getImgSrc(item, true)
            })
          })
          // console.log(newArr1,'newArr1')

          if (!val) {
            this.tableData = this.tableDataClone
          } else {
            this.tableData = newArr1
          }

          this.setAPPNameList()

          // console.log(newArr,'dddddd')

        },
        changeDay(val) {
          if (val == '100') {
            let arr = []
            this.tableData.map(value => {
              if (this.getTodayTime(value.time) == this.getTodayTime(new Date().getTime())) {
                arr.push(value)
              }
            })
            this.tableData = arr
          } else {
            this.tableData = this.tableDataClone
          }
          this.setAPPNameList()
        },
        setAPPNameList() {
          let obj = {}
          this.appNameList = []
          this.tableData.map(value => {
            if (!obj[value.appName]) {
              obj[value.appName] = value.appName
              this.appNameList.push({
                text: value.appName,
                value: value.appName
              })
            }
          })
        },
        getTodayTime(currentTime) {
          // if (autoUtils.getTodayTime(modedata.time) == autoUtils.getTodayTime(time.nowStamp())) {}
          // 提取年、月、日信息
          currentTime = Number(currentTime)
          const year = new Date(currentTime).getFullYear(); // 年份
          const month = new Date(currentTime).getMonth() + 1; // 月份（注意月份从0开始计数）
          const day = new Date(currentTime).getDate(); // 日期
          return year + '-' + month + '-' + day
        },
        filterHandler(value, row, column) {
          const property = column['property'];
          // console.log(this.timestampToTime(row[property]),value)
          return row[property].indexOf(value) > -1
        },
        filterModelAdType(value, row, column) {
          const property = column['property'];
          return row[property].adType.indexOf(value) > -1
        },
        filterModel(value, row, column) {
          const property = column['property'];
          return row[property].indexOf(value) > -1
        },
        filterModelName(value, row, column) {
          const property = column['property'];
          return row[property].indexOf(value) > -1
        },
        confirm() {
          if (this.tokenData) {
            // window.href = window.location.href + '?token=' + this.tokenData
            window.localStorage.setItem('tokenData', this.tokenData)
            this.loadData()
          }
        },
        GetQueryString(name) {
          var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
          var r = window.location.search.substr(1).match(reg);
          if (r != null) {
            return unescape(r[2]);
          }
          return null;
        },
        timestampToTime(timestamp, year) {
          // 时间戳为10位需*1000，时间戳为13位不需乘1000
          var date = new Date(Number(timestamp));
          var Y = date.getFullYear() + "-";
          var M =
            (date.getMonth() + 1 < 10 ?
              "0" + (date.getMonth() + 1) :
              date.getMonth() + 1) + "-";
          var D = (date.getDate() < 10 ? "0" + date.getDate() : date.getDate()) + " ";
          var h = (date.getHours() < 10 ? "0" + date.getHours() : date.getHours()) + ":";
          var m = (date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes()) + ":";
          var s = (date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds());
          if (year) {
            return Y + M + D
          } else {
            return Y + M + D + h + m + s;
          }

        },
        getSummaries(param) {
          const {
            columns,
            data
          } = param;
          const sums = [];
          columns.forEach((column, index) => {
            if (index === 0) {
              sums[index] = '合计';
              return;
            }
            const values = data.map(item => Number(item[column.property]));
            if (!values.every(value => isNaN(value)) && column.property != 'phoneId' && column.property !=
              'lastLookTime') {
              sums[index] = values.reduce((prev, curr) => {
                const value = Number(curr);
                if (!isNaN(value)) {
                  return prev + curr;
                } else {
                  return prev;
                }
              }, 0);
              sums[index] += ' 个';
            } else {
              sums[index] = '--';
            }
          });

          return sums;
        },
        changeRow(row) {
          // console.log(row)
          row.current = 1
          row.pageSize = 15
          row.currentSuccessData = row.successAdList.slice(0, 15)
          row.successAdList.map(value => {
            this.getImgSrc(value, true)
          })
        },
        handlePageRow(current, row) {
          console.log(current, row)
          row.currentSuccessData = row.successAdList.slice((current - 1) * row.pageSize, current * row.pageSize)
        },
        getImgSrc(value, isAd) {
          if (isAd) {
            value.time = value.lastLookTime
          }
          // console.log(this.imgDataTotal,'aaaaa')
          this.imgDataTotal.map(item => {
            if (value.time && value.appName.indexOf(item.appName) > -1 && item.model.indexOf(value.phoneId) > -
              1 && Math.abs(value.time - item.timeStr) < 5 * 60 * 1000) {
              value.img = item.download_url
            }
          })
        },
        uniqueAdArr(arr) {
          for (var i = 0; i < arr.length; i++) {
            for (var j = i + 1; j < arr.length; j++) {
              if (arr[i].phoneId == arr[j].phoneId) {
                arr.splice(j, 1);
                j--;
              }
            }
          }
          return arr;
        },
        uniqueAdNameArr(arr) {
          for (var i = 0; i < arr.length; i++) {
            for (var j = i + 1; j < arr.length; j++) {
              if (arr[i].appName == arr[j].appName) {
                arr.splice(j, 1);
                j--;
              }
            }
          }
          return arr;
        },
        getAppAdTime(name) {
          let adListData = this.tableData
          let nowTime = new Date().getTime();
          let appTime = 0 // 当前手机当前小程序
          let phoneTimeList = [0] // 当前手机不同小程序
          let otherPhoneTimeList = [0] // 其他手机的相同小程序
          let otherPhoneOtherAppList = [0] // 其他手机所有小程序
          let phoneId = '131391382'
          for (let i = 0; i < adListData.length; i++) {
            // let currentTime = adListData[i].lastLookTime
            let currentTime = new Date().getTime() - 60 * 60 * 1000
            if (phoneId == adListData[i].phoneId) {
              // console.log("相同手机")
              if (name == adListData[i].appName) {
                // 当前手机 当前小程序 上一次观看时间
                appTime = currentTime
              } else {
                // 当前手机 不同小程序 上一次观看时间
                phoneTimeList.push(currentTime)
              }
            } else {
              if (name == adListData[i].appName) {
                // 其他手机 相同小程序 上一次观看时间
                otherPhoneTimeList.push(currentTime)
              } else {
                //其他手机 不相同小程序
                otherPhoneOtherAppList.push(currentTime)
              }
            }
          }
          // 大到小 就是 找到最近一次观看的时间
          let maxTime2 = phoneTimeList.sort((a, b) => b - a)[0]
          let maxTime3 = otherPhoneTimeList.sort((a, b) => b - a)[0]
          let maxTime4 = otherPhoneOtherAppList.sort((a, b) => b - a)[0]

          //括号里是当前时间距离上一次广告的时间  用标准时间-括号时间就是 剩余多长时间可以观看  数值越大 等待时间越长
          let AutoGlobDataBiaozhun1Value = 2 * 60 * 60 * 1000 - (nowTime - appTime)
          let AutoGlobDataBiaozhun2Value = 10 * 60 * 1000 - (nowTime - maxTime2)
          let AutoGlobDataBiaozhun3Value = 10 * 60 * 1000 - (nowTime - maxTime3)
          let AutoGlobDataBiaozhun4Value = 5 * 60 * 1000 - (nowTime - maxTime4)

          let maxAdTime = [AutoGlobDataBiaozhun1Value, AutoGlobDataBiaozhun2Value, AutoGlobDataBiaozhun3Value,
            AutoGlobDataBiaozhun4Value
          ]

          let leftTime = maxAdTime.sort((a, b) => b - a)[0]

          leftTime = leftTime > 0 ? leftTime : 0

          return leftTime
        },
        handleTableData(res) {
          // console.log(this.getAppAdTime('优创汇'),'剩余时间')
          this.tableData = res.map(item => {
            item.currentSuccessData = []
            return item
          })
          let cloneData = JSON.parse(JSON.stringify(this.tableData))
          this.modelList = this.uniqueAdArr(cloneData).map(value => {
            // value.text = value.model+"("+value.phoneId+")"
            value.text = (this.phoneIdToNameList[value.phoneId] ? this.phoneIdToNameList[value.phoneId] : value.model) + `(${value.phoneId})`
            value.value = value.phoneId
            return value
          })
          let socketList = localStorage.getItem('socketModelList')
          // console.log("TCL: socketList -> ", socketList)
          if (!socketList) {
            this.socketModelList = this.modelList.map(value => {
              return {
                text: value.text,
                phoneId: value.phoneId,
                messageList: [],
                show: false,
                img: '',
                isOnline: false
              }
            })
          } else {
            this.socketModelList = JSON.parse(socketList)
          }

          setTimeout(() => {
            this.socketModelList.map((value, index) => {
              let objDiv = document.getElementById("scrollView" + index);
              // objDiv.scrollTop = objDiv.scrollHeight;
              // if (objDiv) {
              //   objDiv.scrollTop = 0;
              // }
            })
          }, 3000)
          this.socketModelList = this.socketModelList.map(value => {
            value.show = false
            value.loading = false
            value.img = ''
            value.display = true
            value.isOnline = false
            return value
          })

          localStorage.setItem('socketModelList', JSON.stringify(this.socketModelList))


          this.tableData.map(value => {
            value.time = value.lastLookTime

            // this.getImgSrc(value)
            // value.successAdList.map(ITEM => {
            //   this.getImgSrc(ITEM, true)
            // })
            value.successAdList = value.successAdList.sort((a, b) => b.time - a.time)
            value.successAdList = value.successAdList.reverse()

            value.currentSuccessData = []
          })

          this.setAPPNameList()

          this.tableDataClone = this.tableData
          this.changeDay('100')
          this.deviceId = '123'
          this.dialogVisible = false

          this.initWebsocket()
        },
        loadData() {
          let token = this.GetQueryString('token') ? this.GetQueryString('token') : localStorage.getItem(
            'tokenData')
          if (token) {
            this.tokenData = token
            axios({
              url: `https://gitee.com/api/v5/gists/cw6jlqnhio24pdru0vk1390?access_token=${token}`,
              type: 'GET', // 或者 'POST'，取决于你的请求方式
            }).then(res => {
              // console.log(res, 'aaaa')
              this.dialogVisible = false
              let data = JSON.parse(res.data.files.douyin.content)
              this.handleTableData(data)

              // this.activeName = 'first'

            }).catch(error => {
              console.log(error)
              this.$message.error(error.message)
              this.dialogVisible = true
            })
          } else {
            this.dialogVisible = true
          }
        },

        handlePage(current) {
          let data = JSON.parse(JSON.stringify(this.imgDataTotal))
          data = this.imgDataTotal.slice((current - 1) * this.pageSize, this.pageSize * current)

          // this.imgList = res.data
          // data= data.map(value => {
          //   let str = value.name.split('.jpg')[0]
          //   let str1 = str.split('-')
          //   let time = str1[str1.length - 1]
          //   let name = str1[str1.length - 2]
          //   let model = str.split('-' + name)[0]
          //   value.time = this.timestampToTime(time)
          //   value.appName = this.getPinYin(name)
          //   value.model = model
          //   value.timeStr = time
          //   return value
          // })

          // data = data.sort((a, b) => b.timeStr - a.timeStr)

          // res.data = res.data.slice(0,this.imgNum)

          this.imgList = data
        },
        loadImg() {
          this.loadingData = true
          let token = this.GetQueryString('token') ? this.GetQueryString('token') : localStorage.getItem('tokenData')
          axios({
            url: `https://gitee.com/api/v5/repos/pjmgit/ad-pic/contents/picList`,
            type: 'GET', // 或者 'POST'，取决于你的请求方式
            params: {
              access_token: token
            }
          }).then(res => {
            this.loadingData = false
            this.pageTotal = res.data.length

            res.data = res.data.map(value => {
              let str = value.name.split('.jpg')[0]
              let str1 = str.split('-')
              let time = str1[str1.length - 1]
              let name = str1[str1.length - 2]
              let model = str.split('-' + name)[0]
              value.time = this.timestampToTime(time)
              value.appName = this.getPinYin(name)
              value.model = model
              value.timeStr = time
              return value
            })

            res.data = res.data.sort((a, b) => b.timeStr - a.timeStr)

            this.imgDataTotal = res.data

            this.handlePage(1)
            // this.checkCopyData()
            this.loadData()
          }).catch(error => { })
        },
        timeToTimestamp(str) {
          var timeString = str; // 时分秒字符串
          var currentDate = new Date(); // 当前日期对象
          var timeArray = timeString.split(':'); // 将时分秒字符串拆分为数组
          currentDate.setHours(timeArray[0], timeArray[1], timeArray[2]); // 设置当前日期的时分秒
          var timestamp = currentDate.getTime(); // 获取时间戳
          return timestamp
        },
        beforeHandleCommand(item, command) {
          return {
            'item': item,
            'command': command
          }
        },
        clearData() {
          this.socketModelList = this.socketModelList.map(value => {
            value.messageList = []
            return value
          })
          localStorage.setItem('socketModelList', JSON.stringify(this.socketModelList))
        },
        handleCommand(command) {
          if (command.command == '重启') {
            this.restartTask(command.item)
          } else if (command.command == '养机') {
            this.socket.send(command.item.phoneId + '@养机');
          } else if (command.command == '快速任务') {
            this.socket.send(command.item.phoneId + '@快速任务');
          } else if (command.command == '快速快手任务') {
            this.socket.send(command.item.phoneId + '@快速快手任务');
          } else if (command.command == '停止任务') {
            this.socket.send(command.item.phoneId + '@停止任务');
          } else if (command.command == '截图') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@请求截图')
          } else if (command.command == '自动截图') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@自动截图')
          } else if (command.command == '清除') {
            command.item.messageList = []
          } else if (command.command == '屏幕下滑') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@屏幕下滑')
          } else if (command.command == '屏幕左滑') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@屏幕左滑')
          } else if (command.command == '屏幕右滑') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@屏幕右滑')
          } else if (command.command == '多任务') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@多任务')
          } else if (command.command == '返回主页') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@返回主页')
          } else if (command.command == '清除搜索缓存') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@清除搜索缓存')
          } else if (command.command == '屏幕上滑') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@屏幕上滑')
          } else if (command.command == '快速快手养机任务') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@快速快手养机任务')
          } else if (command.command == '返回') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@返回')
          } else if (command.command == '清除任务缓存') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@清除任务缓存')
          } else if (command.command == '切换成火山版') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@切换成火山版')
          } else if (command.command == '切换成抖音') {
            command.item.loading = true
            this.sendSocketMsg(command.item, '@切换成抖音')
          } else {
            this.$message.warning('功能开发中')
          }
          setTimeout(() => {
            this.sendSocketMsg(command.item, '@请求截图')
          }, 500)
        },
        restartTask(item) {
          // item.loading = true
          this.socket.send(item.phoneId + '@重启任务');
          // if (this.socket.readyState === this.socket.OPEN) {
          // } else {
          //   console.error('WebSocket is not connected.');
          // }
        },
        handleClick(tab, event) {

          // if (tab.name == 'second' && this.imgList.length == 0) {
          //   console.log(tab)
          //   this.loadImg()
          // }
          // if (tab.name == 'three') {
          //   this.initWebsocket()
          // }
        },
        displayTime() {
          var currentTime = new Date();
          var hours = currentTime.getHours() < 10 ? '0' + currentTime.getHours() : currentTime.getHours();
          var minutes = currentTime.getMinutes() < 10 ? '0' + currentTime.getMinutes() : currentTime.getMinutes();
          var seconds = currentTime.getSeconds() < 10 ? '0' + currentTime.getSeconds() : currentTime.getSeconds();
          var timeString = hours + ":" + minutes + ":" + seconds;
          this.timeStr = timeString
        },
        setDataSocket(data) {
          // console.log("TCL: setDataSocket -> ", data)
          let message = data.split('@')
          let model = message[0]
          let str = message[1]

          // console.log(this.socketModelList,model,'ddd')
          let flag = false
          this.socketModelList.map(value => {
            if (value.phoneId == model) {
              flag = true
            }
          })

          const isAllNumbers = /^\d+$/.test(model);
          if (!flag && isAllNumbers) {
            this.socketModelList.push({
              messageList: [],
              phoneId: model,
              display: true,
              img: '',
              isOnline: true,
              loading: false,
              show: true,
              text: '未命名'
            })
          }
          this.socketModelList = this.socketModelList.map((value, index) => {
            if (value.phoneId == model) {
              value.isOnline = true
            }
            if (value.phoneId == model && str != '这是图片' && str != '请求截图' && str != '停止截图' && str != '请求点击') {

              if (str.indexOf('开始等待') > -1) {
                value.messageList.shift()
                value.messageList.unshift(str)
              } else {
                value.messageList.unshift(str)
              }

              if (value.messageList.length > this.staySocketNum) {
                value.messageList = value.messageList.slice(0, this.staySocketNum)
              }
            }
            if (value.phoneId == model && str == '这是图片') {
              let img = message[2]
              value.img = img
              value.loading = false
            }
            let objDiv = document.getElementById("scrollView" + index);
            // objDiv.scrollTop = objDiv.scrollHeight;
            // if (objDiv) {
            //   objDiv.scrollTop = 0;
            // }
            return value
          })

          localStorage.setItem('socketModelList', JSON.stringify(this.socketModelList))
        },
        sendSocketMsg(item, str) {
          // item.loading = true
          // setTimeout(() => {
          //   item.loading = false
          // }, 3500)
          this.socket.send(item.phoneId + str);
        },
        sendMsgToPhone(item) {
          console.log("点击了")
          // item.show = !item.show

          if (item.show) {
            this.sendSocketMsg(item, '@请求截图')
            // item.loading = true
            // this.socket.send(item.phoneId+'@请求截图');
          } else {
            this.socket.send(item.phoneId + '@停止截图');
          }
        },
        updateImg(item) {
          item.loading = true
          this.sendSocketMsg(item, '@请求截图')
          // this.socket.send(item.phoneId+'@请求截图');
          // if (this.socket.readyState === this.socket.OPEN) {
          // } else {
          //   console.error('WebSocket is not connected.');
          // }
        },
        clickImg(event, item) {
          const rect = event.target.getBoundingClientRect();
          const x = event.clientX - rect.left; // 点击位置相对于图片的x坐标
          const y = event.clientY - rect.top; // 点击位置相对于图片的y坐标
          const scaleX = x / event.target.width; // 点击位置相对于图片宽度的百分比
          const scaleY = y / event.target.height; // 点击位置相对于图片高度的百分比

          // console.log(`X: ${scaleX.toFixed(2)}, Y: ${scaleY.toFixed(2)}`);
          this.sendSocketMsg(item, '@请求点击@' + `${scaleX.toFixed(2)},${scaleY.toFixed(2)}`)
          // this.socket.send(item.phoneId+'@请求点击@'+`${scaleX.toFixed(2)},${scaleY.toFixed(2)}`);
          // item.loading = true

        },
        reconectSocket() {
          let that = this
          const RECONNECT_INTERVAL = 5000; // 5秒
          clearTimeout(this.socketTime)
          if (this.socket.readyState === this.socket.OPEN) {
            console.log('websocket已连接')
          } else {
            console.error('WebSocket is not connected.');
            this.socketTime = setTimeout(function () {
              console.log('正在重连...');
              that.socket = null
              that.initWebsocket(); // 尝试重新连接
            }, RECONNECT_INTERVAL);
          }


        },
        initWebsocket() {
          // 重连间隔设置

          if (this.isConect) {
            return;
          }
          if (window.WebSocket) {
            console.log("此浏览器支持WebSocket的！");
          } else {
            console.log("This browser does not support WebSocket.");
          }


          // this.socket = new ws('wss://xztwf4-3001.csb.app')
          // http://140.143.153.128:30001/
          // this.socket = new ws('ws://jiaming1.serv00.net:30001')
          this.socket = new ws('ws://140.143.153.128:30001')
          // this.socket = new ws('ws://127.0.0.1:3001')
          var str = "开始连接中";

          let that = this
          if (!that.isListening) {

            this.socket.onconnecting = function (evn) {
              console.log("socket:onconnecting:", evn);
              // sendMsg("wcj");

            }

            this.socket.onopen = function (evn) {
              console.log("连接成功了");
              that.isConect = true
              // console.log('发了个消息！"' + str + '"');
              // sendMsg(str);

            }

            this.socket.onclose = function (evn) {
              console.log("socket.onclose:", evn);
              console.log('WebSocket 被你关闭了！，您老人家再也没有办法建立连接了?');
              that.isConect = false
              that.reconectSocket()
            }

            this.socket.onmessage = function (evn) {
              // console.log("socket:onmessage:", evn);
              // that.img = evn.data+''

              that.setDataSocket(evn.data + '')
              // console.log('收到消息！"' + evn.data + '"');
              // socket.close()

            }
            that.isListening = true
          }

          function sendMsg(str) {
            console.log("socket:sendMsg:");
            this.socket.send(str);
          }
        }
      }
    })
  </script>
</body>

</html>